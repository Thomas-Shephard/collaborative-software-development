name: Build and Test

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    release:
        types: [ published ]

permissions:
    contents: write

env:
    DOTNET_VERSION: '10.0'

jobs:
    build-and-publish-wpf-app:
        name: Build and Publish WPF App
        runs-on: windows-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
            -   name: Setup .NET ${{ env.DOTNET_VERSION }}
                uses: actions/setup-dotnet@v5
                with:
                    dotnet-version: ${{ env.DOTNET_VERSION }}
                    cache: true
                    cache-dependency-path: |
                        **/*.csproj
                        **/Directory.Build.props
            -   name: Publish Jahoot.Display
                run: |
                    dotnet publish src/Jahoot.Display/Jahoot.Display.csproj `
                      --configuration Release `
                      --runtime win-x64 `
                      --self-contained false `
                      -p:PublishSingleFile=true `
                      -p:IncludeNativeLibrariesForSelfExtract=true `
                      -p:UseAppHost=true `
                      --output ./publish_wpf
            -   name: Upload Jahoot.Display to GitHub Release
                uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
                if: github.event_name == 'release' && github.event.action == 'published'
                with:
                    files: ./publish_wpf/Jahoot.exe

    build-and-test-web-api:
        name: Build and Test Web API
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v6
            -   name: Setup .NET ${{ env.DOTNET_VERSION }}
                uses: actions/setup-dotnet@v5
                with:
                    dotnet-version: ${{ env.DOTNET_VERSION }}
                    cache: true
                    cache-dependency-path: |
                        **/*.csproj
                        **/Directory.Build.props
            -   name: Test
                run: dotnet test backend.slnx --configuration Release --collect:"XPlat Code Coverage" --results-directory ./coverage --settings coverlet.runsettings
            -   name: Install Coverage Checker
                run: dotnet tool install --global CoverageChecker.CommandLine
            -   name: Check Coverage
                run: coveragechecker --format Cobertura --glob-patterns 'coverage/**/coverage.cobertura.xml' --line-threshold 100 --branch-threshold 100
            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
            -   name: Build Docker Image
                uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
                with:
                    file: ./src/Jahoot.WebApi/Dockerfile
                    push: false
                    cache-from: type=gha
                    cache-to: type=gha,mode=max
